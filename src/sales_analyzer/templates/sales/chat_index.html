<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SAP Sales Agent</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ChatGPT Font - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f6f8fa;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }
        .chat-container {
            display: flex;
            height: 100vh;
        }
        .new-chat-btn.active {
            background-color: #10a37f; /* Active button color matches conversation active color */
            color: white;
        }
        .sidebar {
            width: 270px;
            background: #fff;
            border-right: 1px solid #eee;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            transform: translateX(0 );
            transition: transform 0.3s ease;
            z-index: 1050;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        .sidebar.closed {
            transform: translateX(-270px);
        }
        .sidebar-header {
            font-size: 22px;
            font-weight: 600;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .burger {
            font-size: 1.6rem;
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
        }
        .new-chat-btn {
            margin: 10px 0;
            background-color: #10a37f;
            border: none;
            color: #fff;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 6px;
            width: 100%;
        }
        .logout-btn {
            margin-top: auto;
            margin-bottom: 10px;
            background-color: #dc3545;
            border: none;
            color: #fff;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 6px;
            width: 100%;
        }
        .sidebar .list-group-item {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #e1e1e1;
            margin-bottom: 5px;
            border-radius: 8px;
            text-align: left; /* Ensure text aligns left */
        }
        .sidebar .list-group-item:hover {
            background-color: #e1f7e2;
        }
        .sidebar .list-group-item.active {
            background-color: #10a37f;
            color: white;
            border-color: #10a37f;
        }
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-left: 270px;
            padding: 20px;
            background: #f6f8fa;
            transition: margin-left 0.3s ease;
            height: 100vh; /* Ensure main chat takes full height */
        }
        .main-chat.sidebar-closed {
            margin-left: 0;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            /* max-height: 80%; Removed as flex:1 handles height */
            position: relative;
        }
        .message {
            margin-bottom: 16px;
        }
        .message.user .bubble {
            background: #10a37f;
            color: #fff;
            align-self: flex-end;
        }
        .message.assistant .bubble {
            background: #f3f3f3;
            color: #333;
            align-self: flex-start;
        }
        .bubble {
            border-radius: 16px;
            padding: 12px 18px;
            max-width: 65%;
            font-size: 1rem;
            word-wrap: break-word;
        }
        .input-area {
            padding: 16px;
            background: #fff;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
            border-radius: 8px; /* Added for consistency */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* Added for consistency */
        }
        .input-area textarea {
            resize: none;
            width: 100%;
            font-size: 1rem;
            border: 1px solid #ced4da; /* Default border */
            border-radius: 0.375rem; /* Bootstrap default */
            padding: 0.375rem 0.75rem; /* Bootstrap default */
        }
        .input-area textarea:focus {
            outline: none;
            border-color: #10a37f;
            box-shadow: 0 0 0 0.25rem rgba(16, 163, 127, 0.25); /* Bootstrap focus shadow */
        }
        .send-btn {
            background: #10a37f;
            border-radius: 50%;
            color: white;
            border: none;
            padding: 12px 16px;
            font-size: 1.3rem;
            cursor: pointer;
            display: flex; /* For centering icon */
            align-items: center;
            justify-content: center;
            width: 48px; /* Fixed width for circular button */
            height: 48px; /* Fixed height for circular button */
            flex-shrink: 0; /* Prevent shrinking */
        }
        .no-conversations {
            padding: 20px;
            text-align: center;
            color: #888;
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            /* margin: 10px; Removed as it's now part of a bubble */
            align-items: center; /* Vertically align dots */
        }
        .typing-indicator .dot {
            height: 8px;
            width: 8px;
            background-color: #ccc;
            border-radius: 50%;
            animation: blink 1.4s infinite both;
        }
        /* Logout Button Styling */
        .logout-section {
            margin-top: auto; /* Forces the logout button to be at the bottom */
            padding-top: 20px; /* Space between the chat list and the logout button */
        }

        .logout-btn {
            width: 100%; /* Makes the button span across the entire width of the sidebar */
            padding: 10px 15px;
            font-size: 16px;
            background-color: transparent; /* Transparent background */
            border: 1px solid #ccc; /* Light border */
            color: #333; /* Text color */
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Align icon and text to the left */
            border-radius: 4px; /* Rounded corners */
            transition: all 0.3s ease; /* Smooth transition on hover */
        }
        .typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
        @media (max-width: 900px) {
            .main-chat {
                margin-left: 0;
            }
            .sidebar {
                width: 100%;
                transform: translateX(-100%);
                position: fixed;
                top: 0;
                left: 0;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
        .message {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="chat-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header open">
            Chats
            <button class="burger" id="burger-btn">
                <i class="fa fa-bars"></i>
            </button>
        </div>
        <button class="new-chat-btn"><i class="fa fa-plus"></i> New Chat</button>
        <div class="list-group chat-list">
            <!-- List of Chats, will populate dynamically -->
            <div class="no-conversations">No previous conversations</div>
        </div>
        <div class="logout-section">
            <button class="logout-btn">
                <i class="fa fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-chat">
        <div class="messages">
            <!-- Messages will be appended here dynamically -->
        </div>
        <form class="input-area d-flex gap-2">
            <textarea class="form-control flex-grow-1" rows="1" placeholder="Type a message..." style="resize: none;"></textarea>
            <button class="send-btn" type="submit"><i class="fa fa-paper-plane"></i></button>
        </form>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- marked.js for Markdown Parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<!-- SweetAlert2 for alerts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const apiBase = "http://127.0.0.1:8000/api"; // Change to your DRF prefix
let currentChatId = null;
let isSubmitting = false;
let $typingIndicatorElement = null; // To store the dynamically created typing indicator

// Function to get the stored token from localStorage
function getAuthToken( ) {
    return localStorage.getItem('auth_token');
}

// Helper function for authenticated AJAX requests
function sendAuthenticatedRequest(url, method, data = null, successCallback, errorCallback) {
    const token = localStorage.getItem('auth_token');

    if (!token) {
        console.log("No auth token found. Redirecting to login.");
        window.location.href = '/login'; // Redirect to your login page
        return;
    }

    $.ajax({
        url: apiBase + url,
        method: method,
        headers: {
            'Authorization': 'Bearer ' + token,
        },
        data: data,
        contentType: "application/json", // Ensure content type is set for POST/PUT requests
        success: successCallback,
        error: errorCallback
    });
}

// Function to refresh the token using the refresh token
function refreshToken() {
    $.ajax({
        url: apiBase + '/user/token/refresh/', // Adjust if your refresh endpoint is different
        method: 'POST',
        data: {
            refresh: localStorage.getItem('refresh_token')
        },
        success: function(response) {
            localStorage.setItem('auth_token', response.access);
            localStorage.setItem('refresh_token', response.refresh);
            console.log('Token refreshed successfully!');
            fetchChats(); // Re-fetch chats after token refresh
        },
        error: function() {
            console.log('Failed to refresh token');
            localStorage.clear(); // Clear all tokens
            window.location.href = '/login'; // Redirect to login on failure
        }
    });
}

// Fetch the last 10 conversations for the user
// Added a callback parameter to ensure actions happen AFTER chats are fetched and rendered
function fetchChats(callback = null) {
    sendAuthenticatedRequest('/conversations/', 'GET', null, function(response) {
        console.log("Fetched chats:", response);
        const $list = $('.chat-list').empty();
        if (response.length === 0) {
            $list.append('<div class="no-conversations">No previous conversations</div>');
        } else {
            response.forEach(chat => {
                let title = chat.title || 'Untitled Chat';
                $list.append(
                    `<button class="list-group-item list-group-item-action ${chat.uuid === currentChatId ? 'active' : ''}" data-id="${chat.uuid}">${title}</button>`
                );
            });
        }
        if (callback && typeof callback === 'function') {
            callback(); // Execute callback after chats are fetched and DOM is updated
        }
    }, function(xhr, status, error) {
        console.error('Error fetching chats:', error);
        console.log('Response:', xhr.responseText);
        if (xhr.status === 401) {
            refreshToken(); // Attempt to refresh token on unauthorized error
        }
    });
}

// Logout function
function logOut(){
    const token = localStorage.getItem('auth_token');
    const refreshToken = localStorage.getItem('refresh_token');

    $.ajax({
        url: apiBase+'/user/logout/', // Your logout API URL
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + token,
        },
        data: JSON.stringify({ refresh_token: refreshToken }), // Send as JSON
        contentType: "application/json",
        success: function(response) {
            localStorage.removeItem('auth_token');
            localStorage.removeItem('refresh_token');
            localStorage.clear();
            window.location.href = '/login'; // Redirect to the login page
        },
        error: function(xhr, status, error) {
            let detail;
            try {
                detail = JSON.parse(xhr.responseText).detail;
            } catch {
                detail = xhr.responseText;
            }
            if (detail && detail.includes("Token is blacklisted")) {
                // Already logged out, treat as success
                localStorage.removeItem('auth_token');
                localStorage.removeItem('refresh_token');
                localStorage.clear();
                window.location.href = '/login';
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Logout failed. Please try again.',
                });
            }
        }

    });
}

// Fetch messages for a specific conversation by UUID
function fetchMessages(chatId) {
    $('.messages').html('<div class="text-center text-muted">Loading messages...</div>');

    sendAuthenticatedRequest(`/conversations/${chatId}/messages/`, 'GET', null, function(data) {
        console.log("Fetched messages for chat", chatId, ":", data);
        const $messages = $('.messages').empty();
        if (data.length === 0) {
            $messages.append('<div class="text-center text-muted">Start a conversation!</div>');
        } else {
            data.forEach(msg => {
                const isUser = msg.sender === "user";
                const bubbleClass = isUser ? 'user' : 'assistant';
                let html = marked.parse(msg.text);
                $messages.append(`
                    <div class="message ${bubbleClass} d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'}">
                        <div class="bubble">${html}</div>
                    </div>
                `);
            });
        }
        $('.messages').animate({ scrollTop: $('.messages')[0].scrollHeight }, 300);

    }, function(xhr, status, error) {
        console.error("Error fetching messages:", error);
        $('.messages').html('<div class="text-center text-muted">Failed to load messages</div>');
    });
}

// Function to send a message
function sendMessage(content) {
    if (!content.trim() || isSubmitting) return;

    const $input = $('.input-area textarea');
    const $messagesContainer = $('.messages');

    // Disable input and send button
    $input.prop('disabled', true);
    $('.send-btn').prop('disabled', true);

    // Append the user's message immediately
    $messagesContainer.append(`
        <div class="message user d-flex justify-content-end">
            <div class="bubble">${marked.parse(content)}</div>
        </div>
    `);
    $messagesContainer.animate({ scrollTop: $messagesContainer[0].scrollHeight }, 300);

    isSubmitting = true;

    // Typing indicator
    $typingIndicatorElement = $(`
        <div class="message assistant d-flex justify-content-start" id="assistant-typing-indicator">
            <div class="bubble typing-indicator">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        </div>
    `);
    $messagesContainer.append($typingIndicatorElement);
    $messagesContainer.animate({ scrollTop: $messagesContainer[0].scrollHeight }, 300);

    // Figure out if this is a new chat BEFORE the request!
    let isCreatingNewChat = !currentChatId;

    let apiUrl;
    let requestData = { prompt: content };

    if (currentChatId) {
        apiUrl = `/sales/query/existing/${currentChatId}/`;
    } else {
        apiUrl = "/sales/query/";
    }

    sendAuthenticatedRequest(apiUrl, 'POST', JSON.stringify(requestData),
        function(response) {
            isSubmitting = false;
            if ($typingIndicatorElement) {
                $typingIndicatorElement.remove();
                $typingIndicatorElement = null;
            }

            // Debugging info:
            console.log("sendMessage response:", response, "isCreatingNewChat:", isCreatingNewChat);

            if (isCreatingNewChat && response && response.uuid) {
                const newChatUuid = response.uuid;
                currentChatId = newChatUuid;

                // Append assistant reply immediately if present (snappy UX)
                if (response.assistant_message && response.assistant_message.text) {
                    $messagesContainer.append(`
                        <div class="message assistant d-flex justify-content-start">
                            <div class="bubble">${marked.parse(response.assistant_message.text)}</div>
                        </div>
                    `);
                    $messagesContainer.animate({ scrollTop: $messagesContainer[0].scrollHeight }, 300);
                }

                // Now update the sidebar and select the chat (with safe timing)
                fetchChats(() => {
                    setTimeout(() => {
                        // This triggers the sidebar highlight and fetchMessages
                        $(`.chat-list .list-group-item[data-id="${newChatUuid}"]`).trigger('click');
                    }, 0);
                });

                // Re-enable input and send button for next message
                $input.val('').prop('disabled', false).focus();
                $('.send-btn').prop('disabled', false);

            } else {
                // Existing chat: append the assistant's reply as usual
                if (response && response.assistant_message && response.assistant_message.text) {
                    $messagesContainer.append(`
                        <div class="message assistant d-flex justify-content-start">
                            <div class="bubble">${marked.parse(response.assistant_message.text)}</div>
                        </div>
                    `);
                    $messagesContainer.animate({ scrollTop: $messagesContainer[0].scrollHeight }, 300);
                } else if (currentChatId) {
                    // Defensive: fallback to fetching all messages
                    fetchMessages(currentChatId);
                }
                // Re-enable input and send button
                $input.val('').prop('disabled', false).focus();
                $('.send-btn').prop('disabled', false);
            }
        },
        function(xhr, status, error) {
            
            console.log('sendMessage AJAX error', xhr, status, error); // <-- Add this
            isSubmitting = false;
            if ($typingIndicatorElement) {
                $typingIndicatorElement.remove();
                $typingIndicatorElement = null;
            }
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Failed to send message. Please try again later.',
            });
            $input.prop('disabled', false);
            $('.send-btn').prop('disabled', false);
        }
    );
}

// Handling Enter key to send a message
$('.input-area textarea').on('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { // If Enter key is pressed (not Shift+Enter)
        e.preventDefault(); // Prevent the default action of adding a new line
        const content = $(this).val();
        sendMessage(content); // Call sendMessage when Enter is pressed
    }
});

// Send message on click of the send button
$('.input-area').on('submit', function(e) {
    e.preventDefault();
    const content = $(this).find('textarea').val();
    sendMessage(content);
});

// Start a new chat
function startNewChat() {
    currentChatId = null; // Clear current chat ID
    $('.chat-list .list-group-item').removeClass('active'); // Deactivate all sidebar items
    $('.messages').empty().append('<div class="text-center text-muted">Start a new conversation!</div>'); // Clear messages and show prompt
    $('.input-area textarea').val('').focus(); // Clear input and focus
    $('.new-chat-btn').addClass('active'); // Ensure new chat button is active
}

// Select an existing chat
function selectChat(chatId) {
    currentChatId = chatId;
    $('.chat-list .list-group-item').removeClass('active'); // Deactivate all sidebar items
    $(`.chat-list .list-group-item[data-id="${chatId}"]`).addClass('active'); // Activate selected item
    $('.new-chat-btn').removeClass('active'); // Deactivate new chat button
    fetchMessages(chatId); // Fetch messages for the selected chat
}

// Sidebar burger toggle
function openSidebar() {
    $('.sidebar').addClass('open').removeClass('closed');
    $('.main-chat').addClass('sidebar-closed');
}

function closeSidebar() {
    $('.sidebar').removeClass('open').addClass('closed');
    $('.main-chat').removeClass('sidebar-closed');
}

// Document ready function
$(function() {
    fetchChats(); // Initial fetch of chats on page load

    // Logout button click handler
    $('.logout-btn').on('click', function () {
        logOut();
    });

    // Burger menu click handler
    $('#burger-btn').click(function() {
        const isOpen = $('.sidebar').hasClass('open');
        if (isOpen) {
            closeSidebar();
        } else {
            openSidebar();
        }
    });

    // New chat button click handler
    $('.sidebar').on('click', '.new-chat-btn', function() {
        startNewChat();
    });

    // Select chat from list click handler
    $('.chat-list').on('click', '.list-group-item', function() {
        const chatId = $(this).data('id');
        selectChat(chatId);
    });

    // Auto grow textarea
    $('.input-area textarea').on('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // Initialize with a new chat view
    startNewChat();
});
</script>
</body>
</html>

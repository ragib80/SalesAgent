<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ChatGPT Style Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- ChatGPT Font - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f6f8fa;
            margin: 0;
            padding: 0;
            height: 100vh;
        }
        .chat-container {
            display: flex;
            height: 100vh;
        }
        .new-chat-btn.active {
            background-color: #10a37f; /* Active button color matches conversation active color */
            color: white;
        }
        .sidebar {
            width: 270px;
            background: #fff;
            border-right: 1px solid #eee;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            transform: translateX(0);
            transition: transform 0.3s ease;
            z-index: 1050;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        .sidebar.closed {
            transform: translateX(-270px);
        }
        .sidebar-header {
            font-size: 22px;
            font-weight: 600;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .burger {
            font-size: 1.6rem;
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
        }
        .new-chat-btn {
            margin: 10px 0;
            background-color: #10a37f;
            border: none;
            color: #fff;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 6px;
            width: 100%;
        }
        .logout-btn {
            margin-top: auto;
            margin-bottom: 10px;
            background-color: #dc3545;
            border: none;
            color: #fff;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 6px;
            width: 100%;
        }
        .sidebar .list-group-item {
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #e1e1e1;
            margin-bottom: 5px;
            border-radius: 8px;
        }
        .sidebar .list-group-item:hover {
            background-color: #e1f7e2;
        }
        .sidebar .list-group-item.active {
            background-color: #10a37f;
            color: white;
            border-color: #10a37f;
        }
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-left: 270px;
            padding: 20px;
            background: #f6f8fa;
            transition: margin-left 0.3s ease;
        }
        .main-chat.sidebar-closed {
            margin-left: 0;
        }
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            max-height: 80%;
            position: relative;
        }
        .message {
            margin-bottom: 16px;
        }
        .message.user .bubble {
            background: #10a37f;
            color: #fff;
            align-self: flex-end;
        }
        .message.assistant .bubble {
            background: #f3f3f3;
            color: #333;
            align-self: flex-start;
        }
        .bubble {
            border-radius: 16px;
            padding: 12px 18px;
            max-width: 65%;
            font-size: 1rem;
            word-wrap: break-word;
        }
        .input-area {
            padding: 16px;
            background: #fff;
            border-top: 1px solid #eee;
            display: flex;
            gap: 8px;
        }
        .input-area textarea {
            resize: none;
            width: 100%;
            font-size: 1rem;
        }
        .send-btn {
            background: #10a37f;
            border-radius: 50%;
            color: white;
            border: none;
            padding: 12px 16px;
            font-size: 1.3rem;
            cursor: pointer;
        }
        .no-conversations {
            padding: 20px;
            text-align: center;
            color: #888;
        }
        .input-area textarea:focus {
            outline: none;
            border-color: #10a37f;
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            margin: 10px;
        }
        .typing-indicator .dot {
            height: 8px;
            width: 8px;
            background-color: #ccc;
            border-radius: 50%;
            animation: blink 1.4s infinite both;
        }
        /* Logout Button Styling */
        .logout-section {
            margin-top: auto; /* Forces the logout button to be at the bottom */
            padding-top: 20px; /* Space between the chat list and the logout button */
        }

        .logout-btn {
            width: 100%; /* Makes the button span across the entire width of the sidebar */
            padding: 10px 15px;
            font-size: 16px;
            background-color: transparent; /* Transparent background */
            border: 1px solid #ccc; /* Light border */
            color: #333; /* Text color */
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Align icon and text to the left */
            border-radius: 4px; /* Rounded corners */
            transition: all 0.3s ease; /* Smooth transition on hover */
        }
        .typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
        @media (max-width: 900px) {
            .main-chat {
                margin-left: 0;
            }
            .sidebar {
                width: 100%;
                transform: translateX(-100%);
                position: fixed;
                top: 0;
                left: 0;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }
            .sidebar.open {
                transform: translateX(0);
            }
        }
        .message {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body>

<div class="chat-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header open">
            Chats
            <button class="burger" id="burger-btn">
                <i class="fa fa-bars"></i>
            </button>
        </div>
        <button class="new-chat-btn"><i class="fa fa-plus"></i> New Chat</button>
        <div class="list-group chat-list">
            <!-- List of Chats, will populate dynamically -->
            <div class="no-conversations">No previous conversations</div>
        </div>
        <div class="logout-section">
            <button class="logout-btn">
                <i class="fa fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-chat">
        <div class="messages">

             <div class="typing-indicator d-none" id="typing-indicator">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>

        </div>
        <form class="input-area d-flex gap-2">
            <textarea class="form-control flex-grow-1" rows="1" placeholder="Type a message..." style="resize: none;"></textarea>
            <button class="send-btn" type="submit"><i class="fa fa-paper-plane"></i></button>
        </form>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- marked.js for Markdown Parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
const apiBase = "http://127.0.0.1:8000/api"; // Change to your DRF prefix
let currentChatId = null;

// Function to get the stored token from localStorage
function getAuthToken() {
    return localStorage.getItem('auth_token');
}

function sendAuthenticatedRequest(url, method, data = null, successCallback, errorCallback) {
    const token = localStorage.getItem('auth_token');  // Get the auth token from localStorage

    if (!token) {
        console.log("No auth token found.");
        return;
    }

    $.ajax({
        url: apiBase + url,
        method: method,
        headers: {
            'Authorization': 'Bearer ' + token,  // Add the Bearer token in the header
        },
        data: data,
        success: successCallback,
        error: errorCallback
    });
}

// Function to refresh the token using the refresh token
function refreshToken() {
    $.ajax({
        url: '/api/user/token/refresh/',  // Token refresh endpoint
        method: 'POST',
        data: {
            refresh: localStorage.getItem('refresh_token')  // Get the refresh token from localStorage
        },
        success: function(response) {
            // Save the new access token and refresh token
            localStorage.setItem('auth_token', response.access);
            localStorage.setItem('refresh_token', response.refresh);
            console.log('Token refreshed successfully!');
            // Retry the original API request
            fetchChats();
        },
        error: function() {
            console.log('Failed to refresh token');
        }
    });
}

// Helper function to handle AJAX requests with authorization

// Fetch the last 10 conversations for the user
function fetchChats() {
    sendAuthenticatedRequest('/conversations/', 'GET', null, function(response) {
        console.log(response);
        const $list = $('.chat-list').empty();
        response.forEach(chat => {
            let title = chat.title || 'Untitled Chat';
            $list.append(
                `<button class="list-group-item list-group-item-action ${chat.id === currentChatId ? 'active' : ''}" data-id="${chat.uuid}">${title}</button>`
            );
        });
    }, function(xhr, status, error) {
        console.log('Error occurred:', error);
        console.log('Response:', xhr.responseText);  // Log the response to see the error details
    });
}

function logOut(){
    const token = localStorage.getItem('auth_token');  // Get the access token from localStorage
        const refreshToken = localStorage.getItem('refresh_token');  // Get the refresh token

        // Make a POST request to the logout API
        $.ajax({
            url: apiBase+'/user/logout/',  // Your logout API URL
            method: 'POST',
            headers: {
            'Authorization': 'Bearer ' + token,  // Add the Bearer token in the header
             },
            data: {
                refresh_token: refreshToken  // Pass the refresh token in the body
            },
            success: function(response) {
                // On successful logout, clear the tokens and redirect
                localStorage.removeItem('auth_token');
                localStorage.removeItem('refresh_token');
                localStorage.clear(); 
                window.location.href = '/login';  // Redirect to the login page
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Logout failed. Please try again.',
                });
            }
        });
}
// Fetch messages for a specific conversation by UUID
function fetchMessages(chatId) {
    $('.messages').html('<div class="text-center text-muted">Loading...</div>');

    sendAuthenticatedRequest(`/conversations/${chatId}/messages/`, 'GET', null, function(data) {
        console.log(data);
        const $messages = $('.messages').empty();
        data.forEach(msg => {
            const isUser = msg.sender === "user";
            const bubbleClass = isUser ? 'user' : 'assistant';
            let html = marked.parse(msg.text);  // Render markdown
            $messages.append(`
                <div class="message ${bubbleClass} d-flex ${isUser ? 'justify-content-end' : 'justify-content-start'}">
                    <div class="bubble">${html}</div>
                </div>
            `);
        });
        
        $('#typing-indicator').appendTo('.messages').show();
        $('.messages').animate({ scrollTop: $('.messages')[0].scrollHeight }, 300);

    }, function(xhr, status, error) {
        console.error("Error fetching messages:", error);
        $('.messages').html('<div class="text-center text-muted">Failed to load messages</div>');
    });
}
// Send a new message
let isSubmitting = false;  // Prevent multiple submissions

// Function to send a message
function sendMessage(content) {
    if (!content.trim() || isSubmitting) return;  // Avoid submitting empty or duplicate messages
  
    const $input = $('.input-area textarea');
     $input.val('').prop('disabled', false).focus();  // Reset input field
    $input.prop('disabled', true);  // Disable input field to prevent further typing during submission
    $('.send-btn').prop('disabled', true);  // Disable send button to prevent multiple clicks

    // Show typing indicator while waiting for response
    $('#typing-indicator').removeClass('d-none');

    // Append the user's message immediately
    const userMessageHtml = `
        <div class="message user d-flex justify-content-end">
            <div class="bubble">${content}</div>
        </div>
    `;
    $('.messages').append(userMessageHtml);
    $('.messages').animate({ scrollTop: $('.messages')[0].scrollHeight }, 300);

    isSubmitting = true;  // Prevent further submissions until the response is received

    // Send the message to the API
    const token = localStorage.getItem('auth_token');

    if (currentChatId) {
        $.ajax({
            url: apiBase + `/sales/query/existing/${currentChatId}/`,
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + token,
            },
            data: JSON.stringify({ prompt: content }),
            contentType: "application/json",
            success: function(response) {
                isSubmitting = false;  // Allow submission of new messages
                $('#typing-indicator').addClass('d-none'); // Hide typing indicator after receiving the response
                fetchMessages(currentChatId);  // Fetch the updated messages
                $input.val('').prop('disabled', false).focus();  // Reset input field
                $('.send-btn').prop('disabled', false);  // Enable send button again
            },
            error: function() {
                isSubmitting = false;  // Allow submission of new messages
                $('#typing-indicator').addClass('d-none');
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Failed to send message. Please try again later.',
                });
                $input.prop('disabled', false);
                $('.send-btn').prop('disabled', false);
            }
        });
    } else {
        $.ajax({
            url: apiBase + "/sales/query/",
            method: "POST",
            headers: {
                'Authorization': 'Bearer ' + getAuthToken(),
            },
            data: JSON.stringify({ prompt: content }),
            contentType: "application/json",
            success: function(resp) {
                if (resp && resp.uuid) {
                    const newConversationId = resp.uuid;
                    $.ajax({
                        url: apiBase + `/query/existing/${newConversationId}/`,
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + getAuthToken(),
                        },
                        data: JSON.stringify({ prompt: content }),
                        contentType: "application/json",
                        success: function() {
                            currentChatId = newConversationId;
                            fetchChats();
                            fetchMessages(currentChatId);
                        },
                        error: function() {
                            $('#typing-indicator').addClass('d-none');
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Failed to send message. Please try again later.',
                            });
                            $input.prop('disabled', false);
                            $('.send-btn').prop('disabled', false);
                        }
                    });
                }
                $input.val('').prop('disabled', false).focus();
                $('.send-btn').prop('disabled', false);
            },
            error: function() {
                $('#typing-indicator').addClass('d-none');
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Failed to create a new conversation. Please try again later.',
                });
                $input.prop('disabled', false);
                $('.send-btn').prop('disabled', false);
            }
        });
    }
}

// Handling Enter key to send a message
$('.input-area textarea').on('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {  // If Enter key is pressed (not Shift+Enter)
        e.preventDefault();  // Prevent the default action of adding a new line
        const content = $(this).val();
        sendMessage(content);  // Call sendMessage when Enter is pressed
    }
});

// Send message on click of the send button
$('.input-area').on('submit', function(e) {
    e.preventDefault();
    const content = $(this).find('textarea').val();
    sendMessage(content);
});

// Start a new chat
function startNewChat() {
    currentChatId = null;
    $('.chat-list .list-group-item').removeClass('active');
    $('.messages').empty();
    $('.input-area textarea').val('').focus();
}

// Select an existing chat
function selectChat(chatId) {
    currentChatId = chatId;
    $('.chat-list .list-group-item').removeClass('active');
    $(`.chat-list .list-group-item[data-id="${chatId}"]`).addClass('active');
    fetchMessages(chatId);
}

// Sidebar burger toggle
function openSidebar() {
    $('.sidebar').addClass('open').removeClass('closed');
    $('.main-chat').addClass('sidebar-closed');
}

function closeSidebar() {
    $('.sidebar').removeClass('open').addClass('closed');
    $('.main-chat').removeClass('sidebar-closed');
}

$(function() {
    fetchChats();

    $('.logout-btn').on('click', function () {
      // or remove auth_token & refresh_token individually
        //window.location.href = '/login/'; // Adjust to your login page path
        logOut()
    });


    // Burger menu click
    $('#burger-btn').click(function() {
        const isOpen = $('.sidebar').hasClass('open');
        if (isOpen) {
            closeSidebar();
        } else {
            openSidebar();
        }
    });

    // New chat
    $('.sidebar').on('click', '.new-chat-btn', function() {
        startNewChat();
    });

    $('.new-chat-btn').on('click', function() {
        $(this).toggleClass('active'); // Toggle the 'active' class to show the active color
        startNewChat();  // Your existing function for starting a new chat
    });


    // Select chat
    $('.chat-list').on('click', '.list-group-item', function() {
        const chatId = $(this).data('id');
        selectChat(chatId);
    });

    // Send message
    $('.input-area').on('submit', function(e) {
        e.preventDefault();
        const content = $(this).find('textarea').val();
        sendMessage(content);
    });

    // Auto grow textarea
    $('.input-area textarea').on('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
});


</script>
</body>
</html>
